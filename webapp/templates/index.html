<header>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
</header>

<div id="carte_campus"></div>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        let map = L.map('carte_campus');

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '©️ OpenStreetMap contributors'
        }).addTo(map);

        // focus on Lille
        map.setView([50.631583072533594, 3.057713469569928], 13);

        let rsuMarkers = []
        fetch('/rsu/all')
            .then(response => response.json())
            .then(data => {
                //console.log(data)
                const rsus = data.rsus
                rsus.forEach(r => {
                    var icon = L.icon({
                        iconUrl: 'https://cdn.iconscout.com/icon/premium/png-256-thumb/data-center-1646945-1397355.png',
                        iconSize: [40, 40]
                    });
                    let marker = L.marker([r.location.lat, r.location.long], { icon: icon }).addTo(map).bindPopup(r.name);
                    rsuMarkers.push(marker)
                });
            })

        let vehicleMarkers = []
        setInterval(() => {
            vehicleMarkers.forEach(marker => {
                marker.remove()
            })
            fetch('/vehicle/all')
                .then(response => response.json())
                .then(data => {
                    //console.log(data)
                    const vehicles = data.vehicles
                    vehicles.forEach(v => {
                        var icon = L.icon({
                            iconUrl: 'https://static.vecteezy.com/system/resources/previews/001/193/920/non_2x/convertible-car-png.png',
                            iconSize: [20, 10]
                        });
                        let marker = L.marker([v.location.lat, v.location.long], { icon: icon }).addTo(map).bindPopup(v.name);
                        vehicleMarkers.push(marker)
                    });
                })
        }, 1000);

        // handle zoom
        map.on('zoomend', function (e) {

            let level = map.getZoom();
            console.log("zoom level", level)  
            
            let rsuSize = level + 25
            rsuMarkers.forEach(marker => {
                var icon = L.icon({
                    iconUrl: 'https://cdn.iconscout.com/icon/premium/png-256-thumb/data-center-1646945-1397355.png',
                    iconSize: [rsuSize, rsuSize]
                });
                marker.setIcon(icon);
            });

            let vehicleSize = level + 20
            vehicleMarkers.forEach(marker => {
                var icon = L.icon({
                    iconUrl: 'https://static.vecteezy.com/system/resources/previews/001/193/920/non_2x/convertible-car-png.png',
                    iconSize: [vehicleSize, vehicleSize]
                });
                marker.setIcon(icon);
            });

        });
    });

    /*
                const print = console.log
            
                setInterval(
                    function () {
                        fetch('/info')
                            .then(response => response.json())
                            .then(data => {
                                print(data)
                                const vehicles = data.vehicles
                                vehicles.forEach(v => {
                                    print(v)
                                });
                            })
                    },
                    1000
                )
            */
</script>

<style>
    #carte_campus {
        width: 100%;
        height: 75%;
    }
</style>