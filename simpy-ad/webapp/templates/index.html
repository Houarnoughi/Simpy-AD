<header>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
</header>

<div id="carte_campus"></div>

<div class="flex " style="display: flex; border: 1px solid; justify-content: space-around;">
    <div class="text-center font-size-20">
        <div>All tasks</div>
        <span id="all_tasks"></span>
    </div>
    <div class="text-center font-size-20">
        <div>Success</div>
        <span id="success_tasks"></span>
    </div>
    <div class="text-center font-size-20">
        <div>Failed</div>
        <span id="failed_tasks"></span>
    </div>
    <div class="text-center font-size-20">
        <div>To execute</div>
        <span id="tasks_to_execute"></span>
    </div>
    <div class="text-center font-size-20">
        <div>Incomplete</div>
        <span id="incomplete_tasks"></span>
    </div>
    <div class="text-center font-size-20">
        <div>Finished</div>
        <span id="finished_tasks"></span>
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const refreshInterval = 50

        let map = L.map('carte_campus');

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '©️ OpenStreetMap contributors'
        }).addTo(map);

        // focus on Lille
        map.setView([50.631583072533594, 3.057713469569928], 13);

        let rsuMarkers = []
        fetch('/rsu/all')
            .then(response => response.json())
            .then(data => {
                //console.log(data)
                const rsus = data.rsus
                rsus.forEach(r => {
                    var icon = L.icon({
                        iconUrl: 'https://cdn.iconscout.com/icon/premium/png-256-thumb/data-center-1646945-1397355.png',
                        iconSize: [40, 40]
                    });
                    let marker = L.marker([r.lat, r.long], { icon: icon }).addTo(map).bindPopup(r.name);
                    rsuMarkers.push(marker)
                });
            })


        let vehicleMarkers = []
        setInterval(() => {
            vehicleMarkers.forEach(marker => {
                marker.remove()
            })
            fetch('/vehicle/all')
                .then(response => response.json())
                .then(data => {
                    const vehicles = data.vehicles
                    vehicles.forEach(v => {
                        var icon = L.icon({
                            iconUrl: 'https://static.vecteezy.com/system/resources/previews/001/193/920/non_2x/convertible-car-png.png',
                            iconSize: [20, 10]
                        });
                        let marker = L.marker([v.lat, v.long], { icon: icon }).addTo(map).bindPopup(v.name);
                        vehicleMarkers.push(marker)
                    });
                })
        }, 1000);

        setInterval(() => {
            fetch('/stats')
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    let div = document.getElementById('all_tasks')
                    div.innerHTML = data.all_tasks
                    div = document.getElementById('success_tasks')
                    div.innerHTML = data.success_tasks
                    div = document.getElementById('failed_tasks')
                    div.innerHTML = data.failed_tasks
                    div = document.getElementById('tasks_to_execute')
                    div.innerHTML = data.tasks_to_execute
                    div = div = document.getElementById('incomplete_tasks')
                    div.innerHTML = data.incomplete_tasks
                    div = div = document.getElementById('finished_tasks')
                    div.innerHTML = data.finished_tasks
                })
        }, 1000);

        // handle zoom
        map.on('zoomend', function (e) {

            let level = map.getZoom();
            console.log("zoom level", level)

            let rsuSize = level + 25
            rsuMarkers.forEach(marker => {
                var icon = L.icon({
                    iconUrl: 'https://cdn.iconscout.com/icon/premium/png-256-thumb/data-center-1646945-1397355.png',
                    iconSize: [rsuSize, rsuSize]
                });
                marker.setIcon(icon);
            });

            let vehicleSize = level + 20
            vehicleMarkers.forEach(marker => {
                var icon = L.icon({
                    iconUrl: 'https://static.vecteezy.com/system/resources/previews/001/193/920/non_2x/convertible-car-png.png',
                    iconSize: [vehicleSize, vehicleSize]
                });
                marker.setIcon(icon);
            });

        });
    });

</script>

<style>
    #carte_campus {
        width: 100%;
        height: 75%;
    }

.text-center {
    text-align: center;
}

.font-size-20 {
    font-size: 20px;
}

</style>